{% extends "base.html" %}

{% block title %}Voice Profiles - CaseyOS{% endblock %}

{% block head %}
<style>
    .profile-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .profile-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .profile-card.active {
        border-color: #6366f1;
        background-color: #eef2ff;
    }
    .tone-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
    }
    .tone-professional { background-color: #dbeafe; color: #1e40af; }
    .tone-casual { background-color: #d1fae5; color: #065f46; }
    .tone-formal { background-color: #fef3c7; color: #92400e; }
    .tone-friendly { background-color: #fce7f3; color: #9d174d; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Voice Profiles</h1>
            <p class="text-gray-500 text-sm">Define your writing style and tone for AI-generated content</p>
        </div>
        <div class="flex gap-3">
            <a href="/caseyos/voice-training" 
               class="px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
                <span>üìö</span> Training Samples
            </a>
            <button onclick="showCreateModal()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition flex items-center gap-2">
                <span>+</span> New Profile
            </button>
        </div>
    </div>

    <!-- Active Profile -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üé≠</span>
                <div>
                    <span class="text-sm text-indigo-600 font-medium">Active Profile</span>
                    <p id="active-profile-name" class="text-lg font-semibold text-gray-900">Loading...</p>
                </div>
            </div>
            <select id="active-profile-select" onchange="setActiveProfile(this.value)"
                    class="px-4 py-2 border border-indigo-200 rounded-lg bg-white focus:ring-2 focus:ring-indigo-500">
                <option value="">Select profile...</option>
            </select>
        </div>
    </div>

    <!-- Profiles Grid -->
    <div id="profiles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="text-center py-12 col-span-full text-gray-400">
            <div class="animate-pulse">Loading profiles...</div>
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div id="profile-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h3 id="modal-title" class="font-semibold text-gray-900">New Voice Profile</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">‚úï</button>
        </div>
        <form id="profile-form" class="p-4 space-y-4">
            <input type="hidden" id="profile-id">
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Profile Name</label>
                <input type="text" id="profile-name" required
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500"
                       placeholder="e.g., Professional Casey">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tone</label>
                <select id="profile-tone" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                    <option value="professional">Professional</option>
                    <option value="casual">Casual</option>
                    <option value="formal">Formal</option>
                    <option value="friendly">Friendly</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Signature Style</label>
                <input type="text" id="profile-signature"
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg"
                       placeholder="e.g., Best regards">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Calendar Link (optional)</label>
                <input type="url" id="profile-calendar"
                       class="w-full px-4 py-2 border border-gray-200 rounded-lg"
                       placeholder="https://calendly.com/...">
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Max Paragraphs</label>
                    <input type="number" id="profile-max-paragraphs" min="1" max="10" value="3"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">CTA Style</label>
                    <select id="profile-cta-style" class="w-full px-4 py-2 border border-gray-200 rounded-lg">
                        <option value="question">Question</option>
                        <option value="statement">Statement</option>
                        <option value="soft">Soft</option>
                    </select>
                </div>
            </div>
            
            <div class="flex items-center gap-6">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="profile-contractions" checked
                           class="w-4 h-4 text-indigo-600 rounded">
                    <span class="text-sm text-gray-700">Use contractions</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="profile-ps" checked
                           class="w-4 h-4 text-indigo-600 rounded">
                    <span class="text-sm text-gray-700">Include P.S.</span>
                </label>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="profile-single-cta" checked
                           class="w-4 h-4 text-indigo-600 rounded">
                    <span class="text-sm text-gray-700">Single CTA</span>
                </label>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Style Notes</label>
                <textarea id="profile-notes" rows="3"
                          class="w-full px-4 py-2 border border-gray-200 rounded-lg"
                          placeholder="Additional writing style notes..."></textarea>
            </div>
            
            <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
                <button type="button" onclick="closeModal()"
                        class="px-4 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Save Profile
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let profiles = [];
let activeProfileId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadProfiles();
    document.getElementById('profile-form').addEventListener('submit', saveProfile);
});

async function loadProfiles() {
    try {
        const res = await fetch('/api/voice/profiles');
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        profiles = data.profiles || [];
        activeProfileId = data.active_profile_id;
        
        renderProfiles();
        updateActiveProfileSelect();
        updateActiveProfileDisplay();
        
    } catch (e) {
        console.error('Failed to load profiles:', e);
        document.getElementById('profiles-grid').innerHTML = `
            <div class="text-center py-12 col-span-full text-gray-400">
                <p>Failed to load profiles</p>
            </div>`;
    }
}

function renderProfiles() {
    const grid = document.getElementById('profiles-grid');
    
    if (!profiles.length) {
        grid.innerHTML = `
            <div class="text-center py-12 col-span-full text-gray-400">
                <span class="text-4xl block mb-3">üé≠</span>
                <p>No voice profiles yet</p>
                <button onclick="showCreateModal()" 
                        class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                    Create Your First Profile
                </button>
            </div>`;
        return;
    }
    
    grid.innerHTML = profiles.map(profile => `
        <div class="profile-card bg-white rounded-xl border ${profile.id === activeProfileId ? 'border-indigo-500 active' : 'border-gray-100'} shadow-sm p-4">
            <div class="flex items-start justify-between mb-3">
                <div>
                    <h3 class="font-semibold text-gray-900">${profile.name}</h3>
                    <span class="tone-badge tone-${profile.tone}">${profile.tone}</span>
                </div>
                ${profile.id === activeProfileId ? '<span class="text-indigo-600 text-sm font-medium">‚úì Active</span>' : ''}
            </div>
            <div class="space-y-2 text-sm text-gray-600 mb-4">
                <p><span class="text-gray-400">Signature:</span> ${profile.signature_style || '-'}</p>
                <p><span class="text-gray-400">CTA:</span> ${profile.cta_style || 'question'}</p>
                <div class="flex gap-3">
                    ${profile.use_contractions ? '<span class="text-green-600">‚úì Contractions</span>' : ''}
                    ${profile.include_ps ? '<span class="text-green-600">‚úì P.S.</span>' : ''}
                </div>
            </div>
            <div class="flex gap-2">
                ${profile.id !== activeProfileId ? `
                    <button onclick="setActiveProfile('${profile.id}')"
                            class="flex-1 px-3 py-2 bg-indigo-50 text-indigo-600 rounded-lg hover:bg-indigo-100 transition text-sm">
                        Set Active
                    </button>
                ` : ''}
                <button onclick="editProfile('${profile.id}')"
                        class="px-3 py-2 border border-gray-200 rounded-lg hover:bg-gray-50 transition text-sm">
                    Edit
                </button>
                <button onclick="deleteProfile('${profile.id}')"
                        class="px-3 py-2 text-red-500 hover:bg-red-50 rounded-lg transition text-sm">
                    üóëÔ∏è
                </button>
            </div>
        </div>
    `).join('');
}

function updateActiveProfileSelect() {
    const select = document.getElementById('active-profile-select');
    select.innerHTML = '<option value="">Select profile...</option>' +
        profiles.map(p => `<option value="${p.id}" ${p.id === activeProfileId ? 'selected' : ''}>${p.name}</option>`).join('');
}

function updateActiveProfileDisplay() {
    const display = document.getElementById('active-profile-name');
    const active = profiles.find(p => p.id === activeProfileId);
    display.textContent = active ? active.name : 'None selected';
}

async function setActiveProfile(id) {
    try {
        await fetch('/api/voice/profiles/active', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({profile_id: id})
        });
        activeProfileId = id;
        renderProfiles();
        updateActiveProfileSelect();
        updateActiveProfileDisplay();
    } catch (e) {
        console.error('Failed to set active profile:', e);
    }
}

function showCreateModal() {
    document.getElementById('modal-title').textContent = 'New Voice Profile';
    document.getElementById('profile-form').reset();
    document.getElementById('profile-id').value = '';
    document.getElementById('profile-modal').classList.remove('hidden');
}

function editProfile(id) {
    const profile = profiles.find(p => p.id === id);
    if (!profile) return;
    
    document.getElementById('modal-title').textContent = 'Edit Voice Profile';
    document.getElementById('profile-id').value = profile.id;
    document.getElementById('profile-name').value = profile.name || '';
    document.getElementById('profile-tone').value = profile.tone || 'professional';
    document.getElementById('profile-signature').value = profile.signature_style || '';
    document.getElementById('profile-calendar').value = profile.calendar_link || '';
    document.getElementById('profile-max-paragraphs').value = profile.max_paragraphs || 3;
    document.getElementById('profile-cta-style').value = profile.cta_style || 'question';
    document.getElementById('profile-contractions').checked = profile.use_contractions !== false;
    document.getElementById('profile-ps').checked = profile.include_ps !== false;
    document.getElementById('profile-single-cta').checked = profile.single_cta !== false;
    document.getElementById('profile-notes').value = (profile.style_notes || []).join('\n');
    
    document.getElementById('profile-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('profile-modal').classList.add('hidden');
}

async function saveProfile(e) {
    e.preventDefault();
    
    const id = document.getElementById('profile-id').value;
    const data = {
        name: document.getElementById('profile-name').value,
        tone: document.getElementById('profile-tone').value,
        signature_style: document.getElementById('profile-signature').value,
        calendar_link: document.getElementById('profile-calendar').value || null,
        max_paragraphs: parseInt(document.getElementById('profile-max-paragraphs').value),
        cta_style: document.getElementById('profile-cta-style').value,
        use_contractions: document.getElementById('profile-contractions').checked,
        include_ps: document.getElementById('profile-ps').checked,
        single_cta: document.getElementById('profile-single-cta').checked,
        style_notes: document.getElementById('profile-notes').value.split('\n').filter(n => n.trim()),
    };
    
    try {
        const url = id ? `/api/voice/profiles/${id}` : '/api/voice/profiles';
        const method = id ? 'PUT' : 'POST';
        
        await fetch(url, {
            method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        
        closeModal();
        loadProfiles();
    } catch (e) {
        console.error('Failed to save profile:', e);
        alert('Failed to save profile');
    }
}

async function deleteProfile(id) {
    if (!confirm('Delete this profile?')) return;
    
    try {
        await fetch(`/api/voice/profiles/${id}`, {method: 'DELETE'});
        loadProfiles();
    } catch (e) {
        console.error('Failed to delete profile:', e);
    }
}
</script>
{% endblock %}
