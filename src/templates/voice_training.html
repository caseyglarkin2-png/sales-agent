{% extends "base.html" %}

{% block title %}Voice Training - CaseyOS{% endblock %}

{% block head %}
<style>
    .upload-zone {
        border: 2px dashed #cbd5e1;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upload-zone:hover, .upload-zone.dragover {
        border-color: #6366f1;
        background-color: #eef2ff;
    }
    .source-tab.active {
        background-color: #6366f1;
        color: white;
    }
    .sample-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .sample-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .fade-in {
        animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Voice Training</h1>
            <p class="text-gray-500 text-sm">Train the AI to match your writing style</p>
        </div>
        <a href="/caseyos/voice-profiles" 
           class="px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition flex items-center gap-2">
            <span>üé≠</span> Manage Profiles
        </a>
    </div>

    <!-- Stats Bar -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between">
                <span class="text-gray-500 text-sm">Samples</span>
                <span class="text-xl">üìù</span>
            </div>
            <p id="stat-samples" class="text-2xl font-bold text-gray-900 mt-1">-</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between">
                <span class="text-gray-500 text-sm">Words</span>
                <span class="text-xl">üìä</span>
            </div>
            <p id="stat-words" class="text-2xl font-bold text-indigo-600 mt-1">-</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between">
                <span class="text-gray-500 text-sm">Embeddings</span>
                <span class="text-xl">üß†</span>
            </div>
            <p id="stat-embeddings" class="text-2xl font-bold text-green-600 mt-1">-</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm">
            <div class="flex items-center justify-between">
                <span class="text-gray-500 text-sm">Profile Ready</span>
                <span class="text-xl">‚úÖ</span>
            </div>
            <p id="stat-ready" class="text-2xl font-bold text-purple-600 mt-1">-</p>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="p-4 border-b border-gray-100">
            <h2 class="font-semibold text-gray-900 flex items-center gap-2">
                <span class="text-lg">üì•</span> Add Training Samples
            </h2>
        </div>
        
        <!-- Source Tabs -->
        <div class="flex border-b border-gray-100">
            <button onclick="setSourceTab('file')" 
                    class="source-tab active flex-1 py-3 text-sm font-medium text-center hover:bg-gray-50 transition"
                    data-tab="file">
                üìÑ File Upload
            </button>
            <button onclick="setSourceTab('drive')"
                    class="source-tab flex-1 py-3 text-sm font-medium text-center hover:bg-gray-50 transition"
                    data-tab="drive">
                üìÅ Google Drive
            </button>
            <button onclick="setSourceTab('hubspot')"
                    class="source-tab flex-1 py-3 text-sm font-medium text-center hover:bg-gray-50 transition"
                    data-tab="hubspot">
                üî∂ HubSpot Emails
            </button>
            <button onclick="setSourceTab('youtube')"
                    class="source-tab flex-1 py-3 text-sm font-medium text-center hover:bg-gray-50 transition"
                    data-tab="youtube">
                üé• YouTube
            </button>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- File Upload -->
            <div id="tab-file" class="tab-content">
                <div class="upload-zone" id="dropzone"
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <input type="file" id="fileInput" class="hidden" accept=".txt,.md,.doc,.docx,.pdf" onchange="handleFileSelect(event)">
                    <div class="py-8">
                        <span class="text-4xl mb-3 block">üìÑ</span>
                        <p class="text-gray-600 mb-2">Drag & drop files here or click to browse</p>
                        <p class="text-sm text-gray-400">Supports: .txt, .md, .doc, .docx, .pdf</p>
                        <button onclick="document.getElementById('fileInput').click()"
                                class="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                            Choose Files
                        </button>
                    </div>
                </div>
            </div>

            <!-- Google Drive -->
            <div id="tab-drive" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <input type="text" id="driveUrl" placeholder="Paste Google Drive file or folder link..."
                               class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button onclick="importFromDrive()" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                            Import
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">
                        üí° Share the file/folder with the service account or make it accessible via link
                    </p>
                </div>
            </div>

            <!-- HubSpot -->
            <div id="tab-hubspot" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <select id="hubspotFilter" class="px-4 py-2 border border-gray-200 rounded-lg">
                            <option value="sent">Sent Emails</option>
                            <option value="threads">Full Threads</option>
                            <option value="recent">Last 30 Days</option>
                        </select>
                        <input type="number" id="hubspotLimit" value="50" min="10" max="200"
                               class="w-24 px-4 py-2 border border-gray-200 rounded-lg">
                        <button onclick="importFromHubSpot()"
                                class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition">
                            Import from HubSpot
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">
                        üìß Import your sent emails to train on your actual communication style
                    </p>
                </div>
            </div>

            <!-- YouTube -->
            <div id="tab-youtube" class="tab-content hidden">
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <input type="text" id="youtubeUrl" placeholder="Paste YouTube video URL..."
                               class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        <button onclick="importFromYouTube()"
                                class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            Extract Transcript
                        </button>
                    </div>
                    <p class="text-sm text-gray-500">
                        üé§ Extract transcripts from your talks, podcasts, or webinars
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Indicator -->
    <div id="progress-section" class="hidden bg-indigo-50 border border-indigo-200 rounded-xl p-4">
        <div class="flex items-center gap-3">
            <div class="animate-spin h-5 w-5 border-2 border-indigo-600 border-t-transparent rounded-full"></div>
            <span id="progress-text" class="text-indigo-700">Processing...</span>
        </div>
        <div class="mt-3 w-full bg-indigo-100 rounded-full h-2">
            <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
    </div>

    <!-- Samples List -->
    <div class="bg-white rounded-xl border border-gray-100 shadow-sm">
        <div class="p-4 border-b border-gray-100 flex items-center justify-between">
            <h2 class="font-semibold text-gray-900 flex items-center gap-2">
                <span class="text-lg">üìö</span> Training Samples
            </h2>
            <button onclick="loadSamples()" class="text-sm text-indigo-600 hover:text-indigo-800">
                üîÑ Refresh
            </button>
        </div>
        <div id="samples-list" class="p-4 space-y-3">
            <div class="text-center py-8 text-gray-400">
                <div class="animate-pulse">Loading samples...</div>
            </div>
        </div>
    </div>
</div>

<script>
// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadSamples();
});

// Tab switching
function setSourceTab(tab) {
    document.querySelectorAll('.source-tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    document.getElementById(`tab-${tab}`).classList.remove('hidden');
}

// Load stats
async function loadStats() {
    try {
        const res = await fetch('/api/voice/training/stats');
        if (res.ok) {
            const data = await res.json();
            document.getElementById('stat-samples').textContent = data.total_samples || 0;
            document.getElementById('stat-words').textContent = formatNumber(data.total_words || 0);
            document.getElementById('stat-embeddings').textContent = data.embeddings_generated || 0;
            document.getElementById('stat-ready').textContent = data.profile_ready ? 'Yes' : 'No';
        }
    } catch (e) {
        console.error('Failed to load stats:', e);
    }
}

// Load samples
async function loadSamples() {
    const container = document.getElementById('samples-list');
    try {
        const res = await fetch('/api/voice/training/samples?limit=20');
        if (!res.ok) throw new Error('Failed to load');
        
        const data = await res.json();
        
        if (!data.samples || data.samples.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 text-gray-400">
                    <span class="text-4xl block mb-3">üì≠</span>
                    <p>No training samples yet</p>
                    <p class="text-sm mt-1">Upload files or import from connected sources</p>
                </div>`;
            return;
        }
        
        container.innerHTML = data.samples.map(sample => `
            <div class="sample-card fade-in p-4 bg-gray-50 rounded-lg border border-gray-100">
                <div class="flex items-start justify-between">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-lg">${getSourceIcon(sample.source_type)}</span>
                            <span class="font-medium text-gray-800 truncate">${sample.title || 'Untitled'}</span>
                            ${sample.embedding_generated ? '<span class="text-xs px-2 py-0.5 bg-green-100 text-green-700 rounded-full">Embedded</span>' : ''}
                        </div>
                        <p class="text-sm text-gray-500 line-clamp-2">${sample.content_preview || ''}</p>
                        <div class="flex items-center gap-4 mt-2 text-xs text-gray-400">
                            <span>${sample.content_length || 0} chars</span>
                            <span>${formatTimeAgo(sample.created_at)}</span>
                        </div>
                    </div>
                    <button onclick="deleteSample('${sample.id}')" 
                            class="ml-4 text-gray-400 hover:text-red-500 transition">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
        `).join('');
        
    } catch (e) {
        container.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <p>Failed to load samples</p>
            </div>`;
    }
}

// File handling
function handleDragOver(e) {
    e.preventDefault();
    document.getElementById('dropzone').classList.add('dragover');
}

function handleDragLeave(e) {
    document.getElementById('dropzone').classList.remove('dragover');
}

function handleDrop(e) {
    e.preventDefault();
    document.getElementById('dropzone').classList.remove('dragover');
    const files = e.dataTransfer.files;
    uploadFiles(files);
}

function handleFileSelect(e) {
    uploadFiles(e.target.files);
}

async function uploadFiles(files) {
    showProgress('Uploading files...');
    
    for (let i = 0; i < files.length; i++) {
        const file = files[i];
        updateProgress((i / files.length) * 100, `Uploading ${file.name}...`);
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            const res = await fetch('/api/voice/training/upload', {
                method: 'POST',
                body: formData
            });
            if (!res.ok) throw new Error('Upload failed');
        } catch (e) {
            console.error('Upload error:', e);
        }
    }
    
    hideProgress();
    loadStats();
    loadSamples();
}

// Import functions
async function importFromDrive() {
    const url = document.getElementById('driveUrl').value;
    if (!url) return;
    
    showProgress('Importing from Google Drive...');
    
    try {
        const res = await fetch('/api/voice/training/ingest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({source_type: 'google_drive', source_url: url})
        });
        if (!res.ok) throw new Error('Import failed');
        document.getElementById('driveUrl').value = '';
    } catch (e) {
        alert('Import failed: ' + e.message);
    }
    
    hideProgress();
    loadStats();
    loadSamples();
}

async function importFromHubSpot() {
    const filter = document.getElementById('hubspotFilter').value;
    const limit = document.getElementById('hubspotLimit').value;
    
    showProgress('Importing from HubSpot...');
    
    try {
        const res = await fetch('/api/voice/training/ingest/hubspot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({filter, limit: parseInt(limit)})
        });
        if (!res.ok) throw new Error('Import failed');
    } catch (e) {
        alert('Import failed: ' + e.message);
    }
    
    hideProgress();
    loadStats();
    loadSamples();
}

async function importFromYouTube() {
    const url = document.getElementById('youtubeUrl').value;
    if (!url) return;
    
    showProgress('Extracting transcript...');
    
    try {
        const res = await fetch('/api/voice/training/ingest', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({source_type: 'youtube', source_url: url})
        });
        if (!res.ok) throw new Error('Import failed');
        document.getElementById('youtubeUrl').value = '';
    } catch (e) {
        alert('Import failed: ' + e.message);
    }
    
    hideProgress();
    loadStats();
    loadSamples();
}

async function deleteSample(id) {
    if (!confirm('Delete this sample?')) return;
    
    try {
        await fetch(`/api/voice/training/samples/${id}`, {method: 'DELETE'});
        loadStats();
        loadSamples();
    } catch (e) {
        console.error('Delete error:', e);
    }
}

// UI helpers
function showProgress(text) {
    document.getElementById('progress-section').classList.remove('hidden');
    document.getElementById('progress-text').textContent = text;
    document.getElementById('progress-bar').style.width = '0%';
}

function updateProgress(pct, text) {
    document.getElementById('progress-bar').style.width = pct + '%';
    if (text) document.getElementById('progress-text').textContent = text;
}

function hideProgress() {
    document.getElementById('progress-section').classList.add('hidden');
}

function getSourceIcon(type) {
    const icons = {
        'file': 'üìÑ',
        'google_drive': 'üìÅ',
        'hubspot': 'üî∂',
        'youtube': 'üé•',
        'manual': '‚úèÔ∏è'
    };
    return icons[type] || 'üìù';
}

function formatNumber(n) {
    if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
    return n.toString();
}

function formatTimeAgo(timestamp) {
    if (!timestamp) return '';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    
    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
}
</script>
{% endblock %}
