{% extends "base.html" %}

{% block title %}Company Profile - CaseyOS{% endblock %}

{% block head %}
<style>
    .profile-card {
        transition: all 0.2s ease;
    }

    .profile-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .contact-card {
        transition: transform 0.2s;
    }

    .contact-card:hover {
        transform: translateY(-2px);
    }

    .stat-box {
        text-align: center;
        padding: 1rem;
        border-radius: 0.5rem;
        background: #f9fafb;
    }

    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #111827;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6b7280;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header / Breadcrumb -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <a href="/caseyos/companies" class="text-gray-500 hover:text-gray-700">
                ‚Üê Back to Companies
            </a>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="syncCompany()" id="sync-btn"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
                üîÑ Sync from HubSpot
            </button>
            <a id="hubspot-link" href="#" target="_blank"
                class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-sm font-medium transition">
                üî∂ View in HubSpot
            </a>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" class="hidden">
        <!-- Company Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-start justify-between">
                <div class="flex items-center space-x-4">
                    <div class="h-16 w-16 rounded-xl bg-gradient-to-br from-orange-500 to-amber-500 flex items-center justify-center text-white text-2xl font-bold"
                        id="logo">
                        --
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="company-name">Loading...</h1>
                        <a id="domain-link" href="#" target="_blank" class="text-primary hover:underline">--</a>
                        <p class="text-gray-500 mt-1" id="industry">--</p>
                    </div>
                </div>
                <div class="text-right text-sm text-gray-500">
                    <p>Last synced: <span id="synced-at">--</span></p>
                    <p>HubSpot ID: <span id="hubspot-id">--</span></p>
                </div>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mt-6">
                <div class="stat-box">
                    <div class="stat-value" id="stat-contacts">0</div>
                    <div class="stat-label">Contacts</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-deals">0</div>
                    <div class="stat-label">Deals</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-revenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-employees">--</div>
                    <div class="stat-label">Employees</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-lifecycle">--</div>
                    <div class="stat-label">Lifecycle</div>
                </div>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Company Info -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Company Details Card -->
                <div class="profile-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Company Details</h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Annual Revenue</dt>
                            <dd class="text-gray-900" id="annual-revenue">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Location</dt>
                            <dd class="text-gray-900" id="location">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Lead Status</dt>
                            <dd class="text-gray-900" id="lead-status">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Analytics Source</dt>
                            <dd class="text-gray-900" id="analytics-source">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Last Sales Activity</dt>
                            <dd class="text-gray-900" id="last-activity">--</dd>
                        </div>
                    </dl>
                </div>

                <!-- Deals Card -->
                <div class="profile-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Associated Deals</h3>
                    <div id="deals-list" class="space-y-3">
                        <p class="text-gray-500">No deals found</p>
                    </div>
                </div>
            </div>

            <!-- Right Column - Contacts -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-semibold text-gray-900">Contacts at this Company</h3>
                        <span id="contact-count" class="text-sm text-gray-500">0 contacts</span>
                    </div>
                    <div id="contacts-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <p class="text-gray-500 col-span-2">No contacts found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const companyId = '{{ company_id }}';
    let profileData = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadProfile();
    });

    async function loadProfile() {
        try {
            const res = await fetch(`/api/hubspot/companies/${companyId}/profile`);
            if (!res.ok) throw new Error('Failed to load profile');
            profileData = await res.json();
            renderProfile(profileData);
        } catch (e) {
            console.error('Failed to load profile:', e);
            document.getElementById('loading').innerHTML = `
                <div class="text-center text-red-500">
                    <p>Failed to load company profile</p>
                    <button onclick="loadProfile()" class="text-primary hover:underline mt-2">Retry</button>
                </div>
            `;
        }
    }

    function renderProfile(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('profile-content').classList.remove('hidden');

        // Header
        const initials = data.name.slice(0, 2).toUpperCase();
        document.getElementById('logo').textContent = initials;
        document.getElementById('company-name').textContent = data.name;
        document.getElementById('hubspot-id').textContent = data.hubspot_company_id;
        document.getElementById('synced-at').textContent = data.synced_at ? new Date(data.synced_at).toLocaleString() : 'Never';
        document.getElementById('hubspot-link').href = `https://app.hubspot.com/companies/${data.hubspot_company_id}`;

        if (data.domain) {
            document.getElementById('domain-link').textContent = data.domain;
            document.getElementById('domain-link').href = `https://${data.domain}`;
        }

        document.getElementById('industry').textContent = data.industry || 'Industry not set';

        // Stats
        document.getElementById('stat-contacts').textContent = data.contacts?.length || 0;
        document.getElementById('stat-deals').textContent = data.deals?.length || 0;

        // Custom properties
        const props = data.custom_properties || {};
        document.getElementById('stat-revenue').textContent = props.total_revenue ? '$' + Number(props.total_revenue).toLocaleString() : '$0';
        document.getElementById('stat-employees').textContent = props.employee_count || '--';
        document.getElementById('stat-lifecycle').textContent = props.lifecycle_stage || '--';
        document.getElementById('annual-revenue').textContent = props.annual_revenue ? '$' + Number(props.annual_revenue).toLocaleString() : '--';

        const location = [props.city, props.state, props.country].filter(Boolean).join(', ');
        document.getElementById('location').textContent = location || '--';
        document.getElementById('lead-status').textContent = props.lead_status || '--';
        document.getElementById('analytics-source').textContent = props.analytics_source || '--';
        document.getElementById('last-activity').textContent = props.last_sales_activity_date ?
            new Date(props.last_sales_activity_date).toLocaleDateString() : '--';

        // Contacts
        const contactsGrid = document.getElementById('contacts-grid');
        document.getElementById('contact-count').textContent = `${data.contacts?.length || 0} contacts`;

        if (data.contacts && data.contacts.length > 0) {
            contactsGrid.innerHTML = data.contacts.map(contact => `
                <a href="/caseyos/contacts/${contact.id}" 
                   class="contact-card block p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                    <div class="flex items-center space-x-3">
                        <div class="h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 font-medium">
                            ${(contact.firstname?.[0] || contact.email[0]).toUpperCase()}
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">
                                ${escapeHtml((contact.firstname || '') + ' ' + (contact.lastname || '')).trim() || contact.email}
                            </p>
                            <p class="text-sm text-gray-500">${escapeHtml(contact.email)}</p>
                        </div>
                    </div>
                </a>
            `).join('');
        }

        // Deals
        const dealsList = document.getElementById('deals-list');
        if (data.deals && data.deals.length > 0) {
            dealsList.innerHTML = data.deals.map(deal => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="font-medium text-gray-900">${escapeHtml(deal.dealname || 'Untitled Deal')}</p>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-500">${escapeHtml(deal.stage || '--')}</span>
                        <span class="text-green-600 font-medium">${deal.amount ? '$' + Number(deal.amount).toLocaleString() : '--'}</span>
                    </div>
                </div>
            `).join('');
        }
    }

    async function syncCompany() {
        const btn = document.getElementById('sync-btn');
        btn.disabled = true;
        btn.textContent = 'üîÑ Syncing...';

        try {
            const res = await fetch(`/api/hubspot/companies/${companyId}/sync`, { method: 'POST' });
            if (res.ok) {
                alert('Sync queued! Refresh in a few seconds to see updated data.');
            } else {
                throw new Error('Sync failed');
            }
        } catch (e) {
            alert('Failed to queue sync');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ Sync from HubSpot';
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}