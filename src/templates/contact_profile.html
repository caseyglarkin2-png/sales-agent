{% extends "base.html" %}

{% block title %}Contact Profile - CaseyOS{% endblock %}

{% block head %}
<style>
    .profile-card {
        transition: all 0.2s ease;
    }

    .profile-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .timeline-item {
        position: relative;
        padding-left: 2rem;
        border-left: 2px solid #e5e7eb;
    }

    .timeline-item::before {
        content: '';
        position: absolute;
        left: -0.5rem;
        top: 0.25rem;
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        background: #6366f1;
        border: 2px solid white;
    }

    .timeline-item.email::before {
        background: #3b82f6;
    }

    .timeline-item.call::before {
        background: #10b981;
    }

    .timeline-item.meeting::before {
        background: #8b5cf6;
    }

    .timeline-item.note::before {
        background: #f59e0b;
    }

    .property-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header / Breadcrumb -->
    <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
            <a href="/caseyos/contacts" class="text-gray-500 hover:text-gray-700">
                ‚Üê Back to Contacts
            </a>
        </div>
        <div class="flex items-center space-x-3">
            <button onclick="syncContact()" id="sync-btn"
                class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition">
                üîÑ Sync from HubSpot
            </button>
            <a id="hubspot-link" href="#" target="_blank"
                class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-lg text-sm font-medium transition">
                üî∂ View in HubSpot
            </a>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="flex justify-center py-12">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
    </div>

    <!-- Profile Content -->
    <div id="profile-content" class="hidden">
        <!-- Contact Header -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-start justify-between">
                <div class="flex items-center space-x-4">
                    <div class="h-16 w-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-2xl font-bold"
                        id="avatar">
                        --
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900" id="full-name">Loading...</h1>
                        <p class="text-gray-500" id="email">--</p>
                        <div class="flex items-center space-x-2 mt-2">
                            <span id="lifecycle-badge" class="property-badge bg-blue-100 text-blue-700">--</span>
                            <span id="lead-status-badge" class="property-badge bg-green-100 text-green-700">--</span>
                        </div>
                    </div>
                </div>
                <div class="text-right text-sm text-gray-500">
                    <p>Last synced: <span id="synced-at">--</span></p>
                    <p>HubSpot ID: <span id="hubspot-id">--</span></p>
                </div>
            </div>
        </div>

        <!-- Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column - Contact Info -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Contact Details Card -->
                <div class="profile-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Contact Details</h3>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Job Title</dt>
                            <dd class="text-gray-900" id="job-title">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Phone</dt>
                            <dd class="text-gray-900" id="phone">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Mobile</dt>
                            <dd class="text-gray-900" id="mobile">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Times Contacted</dt>
                            <dd class="text-gray-900" id="num-contacted">--</dd>
                        </div>
                        <div>
                            <dt class="text-xs text-gray-500 uppercase">Analytics Source</dt>
                            <dd class="text-gray-900" id="analytics-source">--</dd>
                        </div>
                    </dl>
                </div>

                <!-- Company Card -->
                <div class="profile-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Company</h3>
                    <div id="company-info">
                        <p class="text-gray-500">No company associated</p>
                    </div>
                </div>

                <!-- Deals Card -->
                <div class="profile-card bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="font-semibold text-gray-900 mb-4">Associated Deals</h3>
                    <div id="deals-list" class="space-y-3">
                        <p class="text-gray-500">No deals found</p>
                    </div>
                </div>
            </div>

            <!-- Right Column - Timeline -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="font-semibold text-gray-900">Activity Timeline</h3>
                        <button onclick="loadTimeline()" class="text-sm text-primary hover:underline">
                            Refresh
                        </button>
                    </div>
                    <div id="timeline" class="space-y-4">
                        <p class="text-gray-500">Loading timeline...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const contactId = '{{ contact_id }}';
    let profileData = null;

    document.addEventListener('DOMContentLoaded', function () {
        loadProfile();
        loadTimeline();
    });

    async function loadProfile() {
        try {
            const res = await fetch(`/api/hubspot/contacts/${contactId}/profile`);
            if (!res.ok) throw new Error('Failed to load profile');
            profileData = await res.json();
            renderProfile(profileData);
        } catch (e) {
            console.error('Failed to load profile:', e);
            document.getElementById('loading').innerHTML = `
                <div class="text-center text-red-500">
                    <p>Failed to load contact profile</p>
                    <button onclick="loadProfile()" class="text-primary hover:underline mt-2">Retry</button>
                </div>
            `;
        }
    }

    function renderProfile(data) {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('profile-content').classList.remove('hidden');

        // Header
        const initials = `${(data.firstname || '')[0] || ''}${(data.lastname || '')[0] || ''}`.toUpperCase() || data.email[0].toUpperCase();
        document.getElementById('avatar').textContent = initials;
        document.getElementById('full-name').textContent = data.full_name;
        document.getElementById('email').textContent = data.email;
        document.getElementById('hubspot-id').textContent = data.hubspot_contact_id;
        document.getElementById('synced-at').textContent = data.synced_at ? new Date(data.synced_at).toLocaleString() : 'Never';
        document.getElementById('hubspot-link').href = `https://app.hubspot.com/contacts/${data.hubspot_contact_id}`;

        // Custom properties
        const props = data.custom_properties || {};
        document.getElementById('lifecycle-badge').textContent = props.lifecycle_stage || 'Unknown';
        document.getElementById('lead-status-badge').textContent = props.lead_status || 'Unknown';
        document.getElementById('job-title').textContent = props.job_title || '--';
        document.getElementById('phone').textContent = props.phone || '--';
        document.getElementById('mobile').textContent = props.mobile_phone || '--';
        document.getElementById('num-contacted').textContent = props.num_contacted_times || '0';
        document.getElementById('analytics-source').textContent = props.analytics_source || '--';

        // Company
        if (data.company) {
            document.getElementById('company-info').innerHTML = `
                <a href="/caseyos/companies/${data.company.id}" class="block hover:bg-gray-50 -m-2 p-2 rounded-lg transition">
                    <p class="font-medium text-gray-900">${escapeHtml(data.company.name)}</p>
                    <p class="text-sm text-gray-500">${escapeHtml(data.company.domain || '')}</p>
                    <p class="text-xs text-gray-400">${escapeHtml(data.company.industry || '')}</p>
                </a>
            `;
        }

        // Deals
        if (data.deals && data.deals.length > 0) {
            document.getElementById('deals-list').innerHTML = data.deals.map(deal => `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="font-medium text-gray-900">${escapeHtml(deal.dealname || 'Untitled Deal')}</p>
                    <div class="flex justify-between text-sm mt-1">
                        <span class="text-gray-500">${escapeHtml(deal.stage || '--')}</span>
                        <span class="text-green-600 font-medium">${deal.amount ? '$' + Number(deal.amount).toLocaleString() : '--'}</span>
                    </div>
                </div>
            `).join('');
        }
    }

    async function loadTimeline() {
        const container = document.getElementById('timeline');
        container.innerHTML = '<p class="text-gray-500">Loading...</p>';

        try {
            const res = await fetch(`/api/hubspot/contacts/${contactId}/timeline?limit=30`);
            if (!res.ok) throw new Error('Failed to load timeline');
            const data = await res.json();
            renderTimeline(data.activities);
        } catch (e) {
            console.error('Failed to load timeline:', e);
            container.innerHTML = '<p class="text-red-500">Failed to load timeline</p>';
        }
    }

    function renderTimeline(activities) {
        const container = document.getElementById('timeline');

        if (!activities || activities.length === 0) {
            container.innerHTML = '<p class="text-gray-500">No activity found</p>';
            return;
        }

        const icons = {
            email: 'üìß',
            call: 'üìû',
            meeting: 'üìÖ',
            note: 'üìù'
        };

        container.innerHTML = activities.map(act => {
            const icon = icons[act.type] || 'üìå';
            const title = act.subject || act.title || act.body?.slice(0, 50) || 'Activity';
            const timestamp = act.timestamp ? new Date(act.timestamp).toLocaleString() : '--';

            return `
                <div class="timeline-item ${act.type} pb-4">
                    <div class="flex items-start justify-between">
                        <div>
                            <span class="text-lg mr-2">${icon}</span>
                            <span class="font-medium text-gray-900">${escapeHtml(title)}</span>
                            ${act.direction ? `<span class="ml-2 text-xs text-gray-500">(${act.direction})</span>` : ''}
                        </div>
                        <span class="text-xs text-gray-400">${timestamp}</span>
                    </div>
                    ${act.body ? `<p class="text-sm text-gray-600 mt-1 ml-7">${escapeHtml(act.body)}</p>` : ''}
                </div>
            `;
        }).join('');
    }

    async function syncContact() {
        const btn = document.getElementById('sync-btn');
        btn.disabled = true;
        btn.textContent = 'üîÑ Syncing...';

        try {
            const res = await fetch(`/api/hubspot/contacts/${contactId}/sync`, { method: 'POST' });
            if (res.ok) {
                alert('Sync queued! Refresh in a few seconds to see updated data.');
            } else {
                throw new Error('Sync failed');
            }
        } catch (e) {
            alert('Failed to queue sync');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ Sync from HubSpot';
        }
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}