{% extends "base.html" %}

{% block title %}Queue Item Detail ‚Ä¢ CaseyOS{% endblock %}

{% block head %}
<style>
    .detail-card {
        background: white;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .detail-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
    }

    .priority-badge {
        font-size: 1.25rem;
        font-weight: 700;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
    }

    .priority-high {
        background: #fef2f2;
        color: #dc2626;
    }

    .priority-medium {
        background: #fffbeb;
        color: #d97706;
    }

    .priority-low {
        background: #f0fdf4;
        color: #16a34a;
    }

    .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .meta-item {
        padding: 1rem;
        background: #f9fafb;
        border-radius: 0.5rem;
    }

    .meta-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #6b7280;
        margin-bottom: 0.25rem;
    }

    .meta-value {
        font-size: 0.9375rem;
        color: #111827;
        font-weight: 500;
    }

    .draft-section {
        margin-top: 1.5rem;
    }

    .draft-section h3 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: #374151;
    }

    .draft-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.9375rem;
        transition: border-color 0.15s, box-shadow 0.15s;
    }

    .draft-input:focus {
        outline: none;
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .draft-textarea {
        min-height: 200px;
        font-family: inherit;
        line-height: 1.5;
        resize: vertical;
    }

    .action-buttons {
        display: flex;
        gap: 0.75rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
    }

    .btn {
        padding: 0.625rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        font-size: 0.875rem;
        cursor: pointer;
        border: 1px solid transparent;
        transition: all 0.15s;
    }

    .btn-primary {
        background: #4f46e5;
        color: white;
    }

    .btn-primary:hover {
        background: #4338ca;
    }

    .btn-success {
        background: #10b981;
        color: white;
    }

    .btn-success:hover {
        background: #059669;
    }

    .btn-danger {
        background: #ef4444;
        color: white;
    }

    .btn-danger:hover {
        background: #dc2626;
    }

    .btn-secondary {
        background: white;
        color: #374151;
        border-color: #d1d5db;
    }

    .btn-secondary:hover {
        background: #f9fafb;
    }

    .btn-outline {
        background: transparent;
        color: #4f46e5;
        border-color: #4f46e5;
    }

    .btn-outline:hover {
        background: #eef2ff;
    }

    .btn-outline:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .reasoning-box {
        background: #f0f9ff;
        border: 1px solid #bfdbfe;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }

    .reasoning-box .label {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: #3b82f6;
        margin-bottom: 0.5rem;
    }

    .toast {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        background: #1f2937;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        z-index: 100;
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s;
    }

    .toast.show {
        opacity: 1;
        transform: translateY(0);
    }

    .toast.success {
        background: #059669;
    }

    .toast.error {
        background: #dc2626;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }

    .spinner {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        border: 3px solid #e5e7eb;
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .back-link {
        display: inline-flex;
        align-items: center;
        color: #6b7280;
        text-decoration: none;
        margin-bottom: 1rem;
        font-size: 0.875rem;
    }

    .back-link:hover {
        color: #374151;
    }
</style>
{% endblock %}

{% block content %}
<div id="queue-detail">
    <!-- Back navigation -->
    <a href="/caseyos/queue" class="back-link">
        ‚Üê Back to Queue
    </a>

    <!-- Loading state -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading item...</p>
    </div>

    <!-- Content (hidden until loaded) -->
    <div id="content" style="display: none;">
        <!-- Header -->
        <div class="detail-card">
            <div class="detail-header">
                <div>
                    <h1 id="item-title" class="text-xl font-bold text-gray-900"></h1>
                    <p id="item-description" class="text-gray-500 mt-1"></p>
                </div>
                <div id="priority-badge" class="priority-badge"></div>
            </div>

            <!-- Meta grid -->
            <div class="meta-grid">
                <div class="meta-item">
                    <div class="meta-label">Contact</div>
                    <div class="meta-value" id="meta-contact">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Action Type</div>
                    <div class="meta-value" id="meta-action-type">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Domain</div>
                    <div class="meta-value" id="meta-domain">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Status</div>
                    <div class="meta-value" id="meta-status">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Due By</div>
                    <div class="meta-value" id="meta-due-by">-</div>
                </div>
                <div class="meta-item">
                    <div class="meta-label">Created</div>
                    <div class="meta-value" id="meta-created">-</div>
                </div>
            </div>

            <!-- Reasoning -->
            <div id="reasoning-section" class="reasoning-box" style="display: none;">
                <div class="label">üí° Why This Action</div>
                <p id="reasoning-text"></p>
            </div>
        </div>

        <!-- Draft Editor (for email actions) -->
        <div id="draft-section" class="detail-card" style="display: none;">
            <h2 class="text-lg font-semibold mb-4">üìß Draft Email</h2>

            <div class="draft-section">
                <h3>To</h3>
                <input type="email" id="draft-recipient" class="draft-input" placeholder="recipient@example.com">
            </div>

            <div class="draft-section">
                <h3>Subject</h3>
                <input type="text" id="draft-subject" class="draft-input" placeholder="Email subject">
                <div class="flex justify-between mt-1 text-xs text-gray-500">
                    <span>Keep subject concise (5-9 words ideal)</span>
                    <span id="subject-chars">0 chars</span>
                </div>
            </div>

            <div class="draft-section">
                <h3>Body</h3>
                <textarea id="draft-body" class="draft-input draft-textarea" placeholder="Email body..."
                    oninput="updateBodyStats()"></textarea>
                <div class="flex justify-between mt-1 text-xs text-gray-500">
                    <span id="body-words">0 words</span>
                    <span id="body-chars">0 chars</span>
                </div>
            </div>

            <!-- Signature Preview (Sprint 53) -->
            <div class="draft-section" id="signature-section">
                <h3>
                    Signature
                    <span class="text-sm font-normal text-gray-500">(auto-attached on send)</span>
                </h3>
                <div id="signature-preview" class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <pre id="signature-text"
                        class="text-sm text-gray-700 whitespace-pre-wrap">Loading signature...</pre>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <a href="/caseyos/settings" class="text-primary hover:underline">Edit signature in Settings ‚Üí
                        Profile</a>
                </p>
            </div>

            <div class="action-buttons">
                <button onclick="regenerateDraft()" class="btn btn-outline" id="btn-regenerate">
                    üîÑ Regenerate
                </button>
                <button onclick="saveDraft()" class="btn btn-primary">
                    üíæ Save Draft
                </button>
                <button onclick="previewEmail()" class="btn btn-secondary">
                    üëÅ Preview
                </button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="detail-card">
            <h2 class="text-lg font-semibold mb-4">Actions</h2>
            <div class="action-buttons">
                <button onclick="executeAction(false)" class="btn btn-primary" id="btn-execute">
                    ‚ñ∂ Execute
                </button>
                <button onclick="executeAction(true)" class="btn btn-secondary" id="btn-preview">
                    üëÅ Preview Only
                </button>
                <button onclick="completeItem()" class="btn btn-success" id="btn-complete">
                    ‚úì Mark Complete
                </button>
                <button onclick="skipItem()" class="btn btn-danger" id="btn-skip">
                    Skip
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
    const itemId = '{{ item_id }}';
    const API_BASE = '/api/command-queue';
    let currentItem = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
        await loadItem();
        await loadSignaturePreview();
    });

    // Load signature preview (Sprint 53)
    async function loadSignaturePreview() {
        try {
            const res = await fetch('/api/users/me/signature-preview');
            if (res.ok) {
                const data = await res.json();
                const sigText = document.getElementById('signature-text');
                if (sigText && data.plain_text) {
                    sigText.textContent = data.plain_text;
                }
            }
        } catch (err) {
            console.error('Failed to load signature:', err);
        }
    }

    async function loadItem() {
        try {
            const res = await fetch(`${API_BASE}/${itemId}?enrich=true`);
            if (!res.ok) throw new Error('Item not found');

            currentItem = await res.json();
            renderItem(currentItem);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        } catch (err) {
            console.error('Failed to load item:', err);
            document.getElementById('loading').innerHTML = `
                <p style="color: #dc2626;">‚ùå Failed to load item</p>
                <a href="/caseyos/queue" class="btn btn-secondary" style="margin-top: 1rem;">
                    Back to Queue
                </a>
            `;
        }
    }

    function renderItem(item) {
        // Title and description
        document.getElementById('item-title').textContent = item.title;
        document.getElementById('item-description').textContent = item.description || '';

        // Priority badge
        const priorityBadge = document.getElementById('priority-badge');
        const score = Math.round(item.priority_score);
        priorityBadge.textContent = score;
        if (score >= 70) {
            priorityBadge.className = 'priority-badge priority-high';
        } else if (score >= 40) {
            priorityBadge.className = 'priority-badge priority-medium';
        } else {
            priorityBadge.className = 'priority-badge priority-low';
        }

        // Meta items
        const contactText = item.contact_name
            ? `üë§ ${item.contact_name}${item.contact_email ? ' (' + item.contact_email + ')' : ''}`
            : (item.contact_id || '-');
        document.getElementById('meta-contact').textContent = contactText;

        document.getElementById('meta-action-type').textContent = formatActionType(item.action_type);
        document.getElementById('meta-domain').textContent = (item.domain || 'sales').toUpperCase();
        document.getElementById('meta-status').textContent = item.status.replace('_', ' ').toUpperCase();
        document.getElementById('meta-due-by').textContent = item.due_by ? new Date(item.due_by).toLocaleDateString() : '-';
        document.getElementById('meta-created').textContent = new Date(item.created_at).toLocaleDateString();

        // Reasoning
        if (item.reasoning) {
            document.getElementById('reasoning-section').style.display = 'block';
            document.getElementById('reasoning-text').textContent = item.reasoning;
        }

        // Draft section for email actions
        if (item.action_type === 'send_email' || item.action_type === 'follow_up') {
            document.getElementById('draft-section').style.display = 'block';

            // Populate from action_context if available
            const ctx = item.action_context || {};
            document.getElementById('draft-recipient').value = ctx.recipient || item.contact_email || '';
            document.getElementById('draft-subject').value = ctx.subject || '';
            document.getElementById('draft-body').value = ctx.body || ctx.draft_body || '';
        }
    }

    function formatActionType(type) {
        const map = {
            'send_email': 'üìß Send Email',
            'book_meeting': 'üìÖ Book Meeting',
            'review_deal': 'üíº Review Deal',
            'follow_up': 'üìù Follow Up',
            'check_in': 'üëã Check In',
            'prep_meeting': 'üìã Prep Meeting',
            'send_proposal': 'üìÑ Send Proposal',
        };
        return map[type] || type.replace(/_/g, ' ');
    }

    async function saveDraft() {
        const recipient = document.getElementById('draft-recipient').value;
        const subject = document.getElementById('draft-subject').value;
        const body = document.getElementById('draft-body').value;

        // Build updated action_context
        const updatedContext = {
            ...currentItem.action_context,
            recipient: recipient,
            subject: subject,
            body: body,
        };

        try {
            const res = await fetch(`${API_BASE}/${itemId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action_context: updatedContext,
                })
            });

            if (res.ok) {
                showToast('Draft saved!', 'success');
                currentItem.action_context = updatedContext;
            } else {
                throw new Error('Save failed');
            }
        } catch (err) {
            showToast('Failed to save draft', 'error');
        }
    }

    function previewEmail() {
        const subject = document.getElementById('draft-subject').value;
        const body = document.getElementById('draft-body').value;
        const recipient = document.getElementById('draft-recipient').value;

        // Open preview in new window
        const preview = window.open('', '_blank', 'width=600,height=500');
        preview.document.write(`
            <html>
            <head><title>Email Preview</title></head>
            <body style="font-family: system-ui; padding: 2rem; max-width: 600px; margin: 0 auto;">
                <div style="color: #6b7280; font-size: 0.875rem; margin-bottom: 0.5rem;">To: ${recipient}</div>
                <h2 style="margin: 0 0 1rem 0;">${subject}</h2>
                <div style="white-space: pre-wrap; line-height: 1.6;">${body}</div>
            </body>
            </html>
        `);
    }

    async function executeAction(preview = false) {
        try {
            const res = await fetch(`${API_BASE}/${itemId}/execute`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ preview: preview })
            });

            if (res.ok) {
                const data = await res.json();
                if (preview) {
                    showToast('Preview generated', 'success');
                } else {
                    showToast('Action executed!', 'success');
                    setTimeout(() => window.location.href = '/caseyos/queue', 1500);
                }
            } else {
                throw new Error('Execution failed');
            }
        } catch (err) {
            showToast('Failed to execute action', 'error');
        }
    }

    async function completeItem() {
        try {
            const res = await fetch(`${API_BASE}/${itemId}/complete`, { method: 'POST' });
            if (res.ok) {
                showToast('Item completed! üéâ', 'success');
                setTimeout(() => window.location.href = '/caseyos/queue', 1500);
            } else {
                throw new Error('Failed to complete');
            }
        } catch (err) {
            showToast('Failed to complete item', 'error');
        }
    }

    async function skipItem() {
        try {
            const res = await fetch(`${API_BASE}/${itemId}/skip`, { method: 'POST' });
            if (res.ok) {
                showToast('Item skipped', 'success');
                setTimeout(() => window.location.href = '/caseyos/queue', 1500);
            } else {
                throw new Error('Failed to skip');
            }
        } catch (err) {
            showToast('Failed to skip item', 'error');
        }
    }

    // Sprint 55: Update body stats
    function updateBodyStats() {
        const body = document.getElementById('draft-body').value;
        const words = body.trim().split(/\s+/).filter(w => w.length > 0).length;
        const chars = body.length;

        document.getElementById('body-words').textContent = `${words} words`;
        document.getElementById('body-chars').textContent = `${chars} chars`;
    }

    // Sprint 55: Update subject char count
    document.getElementById('draft-subject')?.addEventListener('input', function () {
        const chars = this.value.length;
        document.getElementById('subject-chars').textContent = `${chars} chars`;
    });

    // Sprint 55: Regenerate draft
    async function regenerateDraft() {
        const btn = document.getElementById('btn-regenerate');
        btn.disabled = true;
        btn.textContent = '‚è≥ Generating...';

        try {
            const ctx = currentItem.action_context || {};
            const res = await fetch('/api/users/drafts/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prospect_email: ctx.recipient || ctx.to,
                    prospect_name: ctx.prospect_name || ctx.contact_name || 'there',
                    company_name: ctx.company_name || ctx.company || 'your company',
                    thread_context: ctx.thread_context,
                })
            });

            if (res.ok) {
                const draft = await res.json();
                document.getElementById('draft-subject').value = draft.subject || '';
                document.getElementById('draft-body').value = draft.body || '';
                updateBodyStats();
                showToast('Draft regenerated!', 'success');
            } else {
                throw new Error('Failed to generate draft');
            }
        } catch (err) {
            console.error('Regenerate failed:', err);
            showToast('Failed to regenerate. Try again.', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ Regenerate';
        }
    }

    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
</script>
{% endblock %}