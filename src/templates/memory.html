{% extends "base.html" %}

{% block title %}Memory - CaseyOS{% endblock %}

{% block head %}
<style>
    .session-card {
        transition: all 0.2s ease;
    }
    .session-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .search-highlight {
        background-color: #fef08a;
        padding: 0 2px;
        border-radius: 2px;
    }
    .json-tree {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="flex flex-col h-full">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">ðŸ§  Memory</h1>
            <p class="text-gray-600">View and search Jarvis conversation sessions and context</p>
        </div>
        <div class="flex items-center space-x-4">
            <!-- Stats Badge -->
            <div id="memory-stats" class="flex items-center space-x-4 text-sm text-gray-600">
                <span class="bg-gray-100 px-3 py-1 rounded-full">
                    <span id="session-count">-</span> sessions
                </span>
                <span class="bg-gray-100 px-3 py-1 rounded-full">
                    <span id="message-count">-</span> messages
                </span>
            </div>
            <!-- New Session Button -->
            <button onclick="createSession()" 
                class="bg-primary hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                + New Session
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="mb-6">
        <div class="flex space-x-4">
            <div class="flex-1 relative">
                <input type="text" id="search-query" 
                    placeholder="Search across all memory..." 
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                <svg class="absolute left-3 top-3.5 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <select id="search-session" class="border border-gray-300 rounded-lg px-4 py-2 text-sm">
                <option value="">All Sessions</option>
            </select>
            <button onclick="searchMemory()" 
                class="bg-gray-800 hover:bg-gray-900 text-white px-6 py-2 rounded-lg text-sm font-medium transition-colors">
                Search
            </button>
        </div>
    </div>

    <!-- Main Content Grid -->
    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Sessions List -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="font-semibold text-gray-900">Sessions</h2>
                    <label class="flex items-center space-x-2 text-sm">
                        <input type="checkbox" id="show-inactive" class="form-checkbox h-4 w-4 text-primary rounded" onchange="loadSessions()">
                        <span class="text-gray-600">Show inactive</span>
                    </label>
                </div>
                <div id="sessions-list" class="divide-y divide-gray-100 max-h-[600px] overflow-y-auto">
                    <!-- Sessions loaded via JS -->
                    <div class="p-8 text-center text-gray-500">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"></div>
                        Loading sessions...
                    </div>
                </div>
            </div>
        </div>

        <!-- Session Detail / Search Results -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div id="detail-header" class="p-4 border-b border-gray-200">
                    <h2 class="font-semibold text-gray-900">Select a session or search</h2>
                    <p class="text-sm text-gray-500">Click on a session to view its conversation history</p>
                </div>
                <div id="detail-content" class="p-4 max-h-[600px] overflow-y-auto">
                    <!-- Content loaded dynamically -->
                    <div class="flex flex-col items-center justify-center py-12 text-gray-400">
                        <svg class="h-16 w-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                        </svg>
                        <p>No session selected</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// State
let currentSessionId = null;
let allSessions = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadSessions();
});

// Load memory stats
async function loadStats() {
    try {
        const response = await fetch('/api/jarvis/memory/stats');
        const data = await response.json();
        document.getElementById('session-count').textContent = data.stats.total_sessions;
        document.getElementById('message-count').textContent = data.stats.total_messages;
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

// Load sessions list
async function loadSessions() {
    const includeInactive = document.getElementById('show-inactive').checked;
    const container = document.getElementById('sessions-list');
    
    try {
        const response = await fetch(`/api/jarvis/sessions?include_inactive=${includeInactive}`);
        const data = await response.json();
        allSessions = data.sessions;
        
        // Populate session dropdown for search
        const dropdown = document.getElementById('search-session');
        dropdown.innerHTML = '<option value="">All Sessions</option>';
        allSessions.forEach(s => {
            dropdown.innerHTML += `<option value="${s.id}">${s.session_name}</option>`;
        });
        
        if (allSessions.length === 0) {
            container.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <p class="mb-2">No sessions found</p>
                    <button onclick="createSession()" class="text-primary hover:underline text-sm">Create your first session</button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = allSessions.map(session => `
            <div class="session-card p-4 cursor-pointer hover:bg-gray-50 ${currentSessionId === session.id ? 'bg-blue-50 border-l-4 border-primary' : ''}" 
                onclick="loadSession('${session.id}')">
                <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-gray-900">${session.session_name}</span>
                    <span class="text-xs px-2 py-0.5 rounded-full ${session.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                        ${session.is_active ? 'active' : 'inactive'}
                    </span>
                </div>
                <div class="text-sm text-gray-500 mb-1">${session.last_topic || 'No topic'}</div>
                <div class="flex items-center justify-between text-xs text-gray-400">
                    <span>${session.message_count} messages</span>
                    <span>${timeAgo(session.last_active)}</span>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load sessions:', error);
        container.innerHTML = `
            <div class="p-8 text-center text-red-500">
                <p>Failed to load sessions</p>
                <button onclick="loadSessions()" class="text-primary hover:underline text-sm mt-2">Retry</button>
            </div>
        `;
    }
}

// Load session detail
async function loadSession(sessionId) {
    currentSessionId = sessionId;
    loadSessions(); // Refresh to show selection
    
    const header = document.getElementById('detail-header');
    const content = document.getElementById('detail-content');
    
    const session = allSessions.find(s => s.id === sessionId);
    header.innerHTML = `
        <div class="flex items-center justify-between">
            <div>
                <h2 class="font-semibold text-gray-900">${session?.session_name || 'Session'}</h2>
                <p class="text-sm text-gray-500">${session?.last_topic || 'No topic'} â€¢ ${session?.message_count || 0} messages</p>
            </div>
            <button onclick="deleteSession('${sessionId}')" class="text-red-500 hover:text-red-700 text-sm">
                Delete Session
            </button>
        </div>
    `;
    
    content.innerHTML = `
        <div class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        </div>
    `;
    
    try {
        const response = await fetch(`/api/jarvis/memory/${sessionId}?limit=50`);
        const data = await response.json();
        
        if (data.messages.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No messages in this session</p>
                </div>
            `;
            return;
        }
        
        content.innerHTML = data.messages.map(msg => `
            <div class="mb-4 ${msg.role === 'user' ? 'ml-8' : msg.role === 'assistant' ? 'mr-8' : ''}">
                <div class="flex items-center space-x-2 mb-1">
                    <span class="text-xs font-medium px-2 py-0.5 rounded ${getRoleBadgeClass(msg.role)}">
                        ${msg.role}
                    </span>
                    <span class="text-xs text-gray-400">${timeAgo(msg.created_at)}</span>
                    ${msg.importance ? `<span class="text-xs text-amber-500">â˜… ${msg.importance}</span>` : ''}
                </div>
                <div class="p-3 rounded-lg ${getRoleBgClass(msg.role)}">
                    <p class="text-sm whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    ${Object.keys(msg.metadata || {}).length > 0 ? `
                        <details class="mt-2">
                            <summary class="text-xs text-gray-400 cursor-pointer">Metadata</summary>
                            <pre class="json-tree mt-1 text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(msg.metadata, null, 2)}</pre>
                        </details>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Failed to load session:', error);
        content.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <p>Failed to load session messages</p>
            </div>
        `;
    }
}

// Search memory
async function searchMemory() {
    const query = document.getElementById('search-query').value.trim();
    const sessionId = document.getElementById('search-session').value;
    
    if (!query) {
        alert('Please enter a search query');
        return;
    }
    
    const header = document.getElementById('detail-header');
    const content = document.getElementById('detail-content');
    
    header.innerHTML = `
        <h2 class="font-semibold text-gray-900">Search Results</h2>
        <p class="text-sm text-gray-500">Searching for: "${query}"</p>
    `;
    
    content.innerHTML = `
        <div class="flex justify-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        </div>
    `;
    
    // If no session selected, search first session (limitation of current API)
    const searchSessionId = sessionId || (allSessions[0]?.id);
    
    if (!searchSessionId) {
        content.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>No sessions available to search</p>
            </div>
        `;
        return;
    }
    
    try {
        const response = await fetch('/api/jarvis/memory/search', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                session_id: searchSessionId,
                query: query,
                limit: 10
            })
        });
        const data = await response.json();
        
        if (data.results.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8 text-gray-500">
                    <p>No matching results found</p>
                </div>
            `;
            return;
        }
        
        content.innerHTML = data.results.map(result => `
            <div class="mb-4 p-3 border border-gray-200 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-medium px-2 py-0.5 rounded ${getRoleBadgeClass(result.role)}">
                        ${result.role}
                    </span>
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-gray-400">${timeAgo(result.created_at)}</span>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">
                            ${(result.similarity * 100).toFixed(0)}% match
                        </span>
                    </div>
                </div>
                <p class="text-sm whitespace-pre-wrap">${escapeHtml(result.content)}</p>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Search failed:', error);
        content.innerHTML = `
            <div class="text-center py-8 text-red-500">
                <p>Search failed. Please try again.</p>
            </div>
        `;
    }
}

// Create new session
async function createSession() {
    const name = prompt('Enter session name:', 'new-session');
    if (!name) return;
    
    try {
        const response = await fetch(`/api/jarvis/sessions/create?session_name=${encodeURIComponent(name)}`, {
            method: 'POST'
        });
        const data = await response.json();
        loadStats();
        loadSessions();
        loadSession(data.session.id);
    } catch (error) {
        console.error('Failed to create session:', error);
        alert('Failed to create session');
    }
}

// Delete session
async function deleteSession(sessionId) {
    if (!confirm('Are you sure you want to delete this session? This cannot be undone.')) {
        return;
    }
    
    try {
        const csrfToken = getCookie('csrf_token');
        await fetch(`/api/jarvis/memory/${sessionId}`, {
            method: 'DELETE',
            headers: { 'X-CSRF-Token': csrfToken }
        });
        currentSessionId = null;
        loadStats();
        loadSessions();
        document.getElementById('detail-header').innerHTML = `
            <h2 class="font-semibold text-gray-900">Session Deleted</h2>
        `;
        document.getElementById('detail-content').innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <p>Session has been deleted</p>
            </div>
        `;
    } catch (error) {
        console.error('Failed to delete session:', error);
        alert('Failed to delete session');
    }
}

// Utility functions
function getRoleBadgeClass(role) {
    switch(role) {
        case 'user': return 'bg-blue-100 text-blue-700';
        case 'assistant': return 'bg-purple-100 text-purple-700';
        case 'system': return 'bg-gray-100 text-gray-700';
        default: return 'bg-gray-100 text-gray-700';
    }
}

function getRoleBgClass(role) {
    switch(role) {
        case 'user': return 'bg-blue-50';
        case 'assistant': return 'bg-purple-50';
        case 'system': return 'bg-gray-50';
        default: return 'bg-gray-50';
    }
}

function timeAgo(dateString) {
    if (!dateString) return 'Unknown';
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'just now';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
    if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
    if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
    return date.toLocaleDateString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let value = "; " + document.cookie;
    let parts = value.split("; " + name + "=");
    if (parts.length == 2) return parts.pop().split(";").shift();
    return '';
}

// Allow Enter key to search
document.getElementById('search-query')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') searchMemory();
});
</script>
{% endblock %}
