{% extends "base.html" %}

{% block title %}Signals | CaseyOS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">üì° Signal Stream</h1>
            <p class="text-gray-600">Real-time events from forms, HubSpot, Gmail, and manual entries</p>
        </div>
        <div class="flex space-x-3">
            <button onclick="refreshSignals()"
                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700 transition">
                üîÑ Refresh
            </button>
        </div>
    </div>

    <!-- Stats Cards -->
    <div id="stats-container" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-blue-500">
            <div class="text-sm text-gray-500">Total Signals</div>
            <div id="stat-total" class="text-2xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-green-500">
            <div class="text-sm text-gray-500">Processed</div>
            <div id="stat-processed" class="text-2xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-yellow-500">
            <div class="text-sm text-gray-500">Pending</div>
            <div id="stat-pending" class="text-2xl font-bold text-gray-900">-</div>
        </div>
        <div class="bg-white rounded-lg shadow p-4 border-l-4 border-purple-500">
            <div class="text-sm text-gray-500">Last 24h</div>
            <div id="stat-recent" class="text-2xl font-bold text-gray-900">-</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex flex-wrap gap-4 items-center">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Source</label>
                <select id="filter-source" onchange="applyFilters()"
                    class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-primary focus:border-primary">
                    <option value="">All Sources</option>
                    <option value="form">üìù Form</option>
                    <option value="hubspot">üî∂ HubSpot</option>
                    <option value="gmail">üìß Gmail</option>
                    <option value="manual">‚úã Manual</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="filter-processed" onchange="applyFilters()"
                    class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-primary focus:border-primary">
                    <option value="">All</option>
                    <option value="true">‚úÖ Processed</option>
                    <option value="false">‚è≥ Pending</option>
                </select>
            </div>
            <div class="flex-1"></div>
            <div class="text-sm text-gray-500">
                Showing <span id="showing-count">0</span> of <span id="total-count">0</span> signals
            </div>
        </div>
    </div>

    <!-- Signals Table -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Source
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Event
                        Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Preview
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions
                    </th>
                </tr>
            </thead>
            <tbody id="signals-table-body" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        Loading signals...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center">
        <button id="btn-prev" onclick="prevPage()" disabled
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
            ‚Üê Previous
        </button>
        <span id="page-info" class="text-sm text-gray-600">Page 1</span>
        <button id="btn-next" onclick="nextPage()"
            class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50">
            Next ‚Üí
        </button>
    </div>
</div>

<!-- Signal Detail Modal -->
<div id="signal-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-medium text-gray-900">Signal Details</h3>
            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>
        </div>
        <div id="signal-modal-content" class="p-6 overflow-y-auto max-h-[60vh]">
            <!-- Content populated by JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // State
    let currentPage = 0;
    const pageSize = 20;
    let totalSignals = 0;

    // Source icons
    const sourceIcons = {
        'form': 'üìù',
        'hubspot': 'üî∂',
        'gmail': 'üìß',
        'manual': '‚úã'
    };

    // Load signals on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadSignals();
        loadStats();
    });

    async function loadStats() {
        try {
            // Get total and processed counts
            const [totalRes, processedRes, pendingRes] = await Promise.all([
                fetch('/api/signals?limit=1'),
                fetch('/api/signals?limit=1&processed=true'),
                fetch('/api/signals?limit=1&processed=false')
            ]);

            const totalData = await totalRes.json();
            const processedData = await processedRes.json();
            const pendingData = await pendingRes.json();

            document.getElementById('stat-total').textContent = totalData.total || 0;
            document.getElementById('stat-processed').textContent = processedData.total || 0;
            document.getElementById('stat-pending').textContent = pendingData.total || 0;
            document.getElementById('stat-recent').textContent = '-'; // TODO: Add 24h filter
        } catch (e) {
            console.error('Failed to load stats:', e);
        }
    }

    async function loadSignals() {
        const source = document.getElementById('filter-source').value;
        const processed = document.getElementById('filter-processed').value;

        let url = `/api/signals?limit=${pageSize}&offset=${currentPage * pageSize}`;
        if (source) url += `&source=${source}`;
        if (processed) url += `&processed=${processed}`;

        try {
            const res = await fetch(url);
            const data = await res.json();

            totalSignals = data.total || 0;
            document.getElementById('showing-count').textContent = data.signals?.length || 0;
            document.getElementById('total-count').textContent = totalSignals;
            document.getElementById('page-info').textContent = `Page ${currentPage + 1} of ${Math.max(1, Math.ceil(totalSignals / pageSize))}`;

            // Update pagination buttons
            document.getElementById('btn-prev').disabled = currentPage === 0;
            document.getElementById('btn-next').disabled = (currentPage + 1) * pageSize >= totalSignals;

            renderSignals(data.signals || []);
        } catch (e) {
            console.error('Failed to load signals:', e);
            document.getElementById('signals-table-body').innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-red-500">
                        Failed to load signals. <button onclick="loadSignals()" class="text-primary underline">Retry</button>
                    </td>
                </tr>
            `;
        }
    }

    function renderSignals(signals) {
        const tbody = document.getElementById('signals-table-body');

        if (!signals.length) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                        No signals found. Signals appear when forms are submitted, HubSpot events occur, or Gmail replies arrive.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = signals.map(signal => {
            const icon = sourceIcons[signal.source] || '‚ùì';
            const preview = getPayloadPreview(signal.payload);
            const statusBadge = signal.processed_at
                ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">‚úÖ Processed</span>'
                : '<span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800">‚è≥ Pending</span>';
            const timeAgo = formatTimeAgo(signal.created_at);

            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-lg">${icon}</span>
                        <span class="ml-2 text-sm font-medium text-gray-900 capitalize">${signal.source}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="text-sm text-gray-900">${signal.event_type}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="text-sm text-gray-600 truncate max-w-xs block">${preview}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${statusBadge}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${timeAgo}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick='showSignalDetail(${JSON.stringify(signal).replace(/'/g, "&#39;")})' 
                                class="text-primary hover:text-indigo-700 text-sm font-medium">
                            View Details
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
    }

    function getPayloadPreview(payload) {
        // Try to extract meaningful preview
        if (payload.email) return `üìß ${payload.email}`;
        if (payload.deal_name) return `üíº ${payload.deal_name}`;
        if (payload.thread_id) return `üßµ Thread: ${payload.thread_id.slice(0, 12)}...`;
        if (payload.name) return `üë§ ${payload.name}`;
        if (payload.company) return `üè¢ ${payload.company}`;
        return JSON.stringify(payload).slice(0, 60) + '...';
    }

    function formatTimeAgo(dateStr) {
        const date = new Date(dateStr);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);

        if (diffMins < 1) return 'Just now';
        if (diffMins < 60) return `${diffMins}m ago`;
        if (diffHours < 24) return `${diffHours}h ago`;
        if (diffDays < 7) return `${diffDays}d ago`;
        return date.toLocaleDateString();
    }

    function showSignalDetail(signal) {
        const modal = document.getElementById('signal-modal');
        const content = document.getElementById('signal-modal-content');

        content.innerHTML = `
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Signal ID</label>
                        <div class="text-sm text-gray-900 font-mono">${signal.id}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Source</label>
                        <div class="text-sm text-gray-900 capitalize">${sourceIcons[signal.source] || ''} ${signal.source}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Event Type</label>
                        <div class="text-sm text-gray-900">${signal.event_type}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Created</label>
                        <div class="text-sm text-gray-900">${new Date(signal.created_at).toLocaleString()}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Processed</label>
                        <div class="text-sm text-gray-900">${signal.processed_at ? new Date(signal.processed_at).toLocaleString() : 'Not yet'}</div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-500">Recommendation ID</label>
                        <div class="text-sm text-gray-900 font-mono">${signal.recommendation_id || '-'}</div>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-500 mb-2">Payload</label>
                    <pre class="bg-gray-100 rounded-lg p-4 text-xs overflow-x-auto">${JSON.stringify(signal.payload, null, 2)}</pre>
                </div>
            </div>
        `;

        modal.classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('signal-modal').classList.add('hidden');
    }

    function refreshSignals() {
        loadSignals();
        loadStats();
    }

    function applyFilters() {
        currentPage = 0;
        loadSignals();
    }

    function prevPage() {
        if (currentPage > 0) {
            currentPage--;
            loadSignals();
        }
    }

    function nextPage() {
        if ((currentPage + 1) * pageSize < totalSignals) {
            currentPage++;
            loadSignals();
        }
    }

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
    });

    // Close modal on background click
    document.getElementById('signal-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('signal-modal')) closeModal();
    });
</script>
{% endblock %}