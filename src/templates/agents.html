{% extends "base.html" %}

{% block title %}Agents - CaseyOS{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">ü§ñ Agent Hub</h1>
                <p class="mt-1 text-sm text-gray-500" id="agent-subtitle">
                    Loading agents...
                </p>
            </div>
            <div class="flex items-center space-x-4">
                <!-- Search Box -->
                <div class="relative">
                    <input type="text" 
                           id="agent-search" 
                           placeholder="Search agents..."
                           class="w-64 pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
                </div>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <span class="h-2 w-2 mr-2 bg-green-400 rounded-full animate-pulse"></span>
                    All Systems Online
                </span>
            </div>
        </div>
    </div>

    <!-- Domain Filter Pills -->
    <div class="flex flex-wrap gap-2" id="domain-filters">
        <button onclick="filterByDomain('all')" 
                class="domain-pill active px-4 py-2 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200 transition-colors"
                data-domain="all">
            All Agents
        </button>
        <!-- Domain pills will be populated dynamically -->
    </div>

    <!-- Agent Categories Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="agents-grid">
        <!-- Loading state -->
        <div class="col-span-full flex items-center justify-center py-12" id="loading-state">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                <span class="text-gray-500">Loading agents...</span>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="stats-grid">
        <div class="bg-white rounded-lg p-4 shadow">
            <div class="text-2xl font-bold text-gray-900" id="stat-total">--</div>
            <div class="text-sm text-gray-500">Total Agents</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow">
            <div class="text-2xl font-bold text-gray-900" id="stat-domains">--</div>
            <div class="text-sm text-gray-500">Domains</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow">
            <div class="text-2xl font-bold text-green-600" id="stat-active">--</div>
            <div class="text-sm text-gray-500">Active</div>
        </div>
        <div class="bg-white rounded-lg p-4 shadow">
            <div class="text-2xl font-bold text-indigo-600">1</div>
            <div class="text-sm text-gray-500">Master (Jarvis)</div>
        </div>
    </div>

    <!-- Agent Detail Modal -->
    <div id="agent-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full mx-4 transform transition-all">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <span class="text-3xl mr-3" id="modal-icon">ü§ñ</span>
                        <div>
                            <h2 class="text-xl font-bold text-gray-900" id="modal-title">Agent Name</h2>
                            <span class="text-sm px-2 py-0.5 rounded-full" id="modal-domain-badge">Domain</span>
                        </div>
                    </div>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
                <p class="text-gray-600 mb-4" id="modal-description">Description</p>
                <div class="mb-4">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">Capabilities</h3>
                    <div class="flex flex-wrap gap-2" id="modal-capabilities"></div>
                </div>
                <div class="text-xs text-gray-400 border-t pt-3 mt-3">
                    <code id="modal-module-path">module.path</code>
                </div>
            </div>
            <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                    Close
                </button>
                <a href="/caseyos/gemini" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    ‚ú® Use with Jarvis
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Domain colors configuration
const DOMAIN_COLORS = {
    sales: { bg: 'bg-indigo-100', text: 'text-indigo-800', dot: 'bg-indigo-400', border: 'border-indigo-200' },
    content: { bg: 'bg-purple-100', text: 'text-purple-800', dot: 'bg-purple-400', border: 'border-purple-200' },
    research: { bg: 'bg-blue-100', text: 'text-blue-800', dot: 'bg-blue-400', border: 'border-blue-200' },
    fulfillment: { bg: 'bg-orange-100', text: 'text-orange-800', dot: 'bg-orange-400', border: 'border-orange-200' },
    contracts: { bg: 'bg-amber-100', text: 'text-amber-800', dot: 'bg-amber-400', border: 'border-amber-200' },
    ops: { bg: 'bg-gray-100', text: 'text-gray-800', dot: 'bg-gray-400', border: 'border-gray-200' },
    data_hygiene: { bg: 'bg-emerald-100', text: 'text-emerald-800', dot: 'bg-emerald-400', border: 'border-emerald-200' }
};

let allAgents = [];
let allDomains = [];
let currentFilter = 'all';

// Fetch agents data on load
document.addEventListener('DOMContentLoaded', async () => {
    try {
        // Fetch agents and domains in parallel
        const [agentsRes, domainsRes, statsRes] = await Promise.all([
            fetch('/api/agents'),
            fetch('/api/agents/domains'),
            fetch('/api/agents/stats')
        ]);
        
        const agentsData = await agentsRes.json();
        const domainsData = await domainsRes.json();
        const statsData = await statsRes.json();
        
        allAgents = agentsData.agents;
        allDomains = domainsData.domains;
        
        // Update subtitle
        document.getElementById('agent-subtitle').textContent = 
            `${agentsData.total} specialized agents across ${allDomains.length} domains ready to assist.`;
        
        // Update stats
        document.getElementById('stat-total').textContent = statsData.total_agents;
        document.getElementById('stat-domains').textContent = statsData.domains;
        document.getElementById('stat-active').textContent = statsData.active;
        
        // Render domain filters
        renderDomainFilters();
        
        // Render agents grouped by domain
        renderAgentsByDomain();
        
    } catch (error) {
        console.error('Failed to load agents:', error);
        document.getElementById('loading-state').innerHTML = `
            <div class="text-center py-8">
                <span class="text-4xl mb-4 block">‚ùå</span>
                <p class="text-gray-500">Failed to load agents. Please refresh the page.</p>
            </div>
        `;
    }
});

function renderDomainFilters() {
    const container = document.getElementById('domain-filters');
    allDomains.forEach(domain => {
        const colors = DOMAIN_COLORS[domain.name] || DOMAIN_COLORS.ops;
        const pill = document.createElement('button');
        pill.className = `domain-pill px-4 py-2 rounded-full text-sm font-medium ${colors.bg} ${colors.text} hover:opacity-80 transition-all`;
        pill.setAttribute('data-domain', domain.name);
        pill.onclick = () => filterByDomain(domain.name);
        pill.innerHTML = `${domain.icon} ${domain.label} <span class="ml-1 opacity-70">(${domain.count})</span>`;
        container.appendChild(pill);
    });
}

function renderAgentsByDomain(filter = 'all', searchQuery = '') {
    const grid = document.getElementById('agents-grid');
    grid.innerHTML = '';
    
    // Group agents by domain
    const grouped = {};
    allDomains.forEach(d => grouped[d.name] = { ...d, agents: [] });
    
    allAgents.forEach(agent => {
        if (grouped[agent.domain]) {
            // Apply search filter
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                const matches = agent.name.toLowerCase().includes(q) ||
                               agent.description.toLowerCase().includes(q) ||
                               agent.capabilities.some(c => c.toLowerCase().includes(q));
                if (!matches) return;
            }
            grouped[agent.domain].agents.push(agent);
        }
    });
    
    // Render each domain card
    Object.entries(grouped).forEach(([domainName, domain]) => {
        if (filter !== 'all' && filter !== domainName) return;
        if (domain.agents.length === 0 && searchQuery) return;
        
        const colors = DOMAIN_COLORS[domainName] || DOMAIN_COLORS.ops;
        
        const card = document.createElement('div');
        card.className = `bg-white shadow rounded-lg p-6 border-l-4 ${colors.border} hover:shadow-lg transition-shadow`;
        
        card.innerHTML = `
            <div class="flex items-center mb-4">
                <span class="text-2xl mr-3">${domain.icon}</span>
                <h2 class="text-lg font-semibold text-gray-900">${domain.label}</h2>
                <span class="ml-auto ${colors.bg} ${colors.text} text-xs font-medium px-2.5 py-0.5 rounded">
                    ${domain.agents.length} agent${domain.agents.length !== 1 ? 's' : ''}
                </span>
            </div>
            <ul class="space-y-2 text-sm text-gray-600">
                ${domain.agents.map(agent => `
                    <li class="flex items-center cursor-pointer hover:text-indigo-600 transition-colors group"
                        onclick="showAgentDetail('${agent.name}')">
                        <span class="h-1.5 w-1.5 ${colors.dot} rounded-full mr-2 group-hover:scale-125 transition-transform"></span>
                        <span>${agent.name}</span>
                        <span class="ml-auto opacity-0 group-hover:opacity-100 text-xs text-gray-400">View ‚Üí</span>
                    </li>
                `).join('')}
            </ul>
        `;
        
        grid.appendChild(card);
    });
    
    // Show empty state if no results
    if (grid.children.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <span class="text-4xl mb-4 block">üîç</span>
                <p class="text-gray-500">No agents found matching "${searchQuery}"</p>
                <button onclick="clearSearch()" class="mt-4 text-indigo-600 hover:text-indigo-800">
                    Clear search
                </button>
            </div>
        `;
    }
}

function filterByDomain(domain) {
    currentFilter = domain;
    
    // Update active pill styling
    document.querySelectorAll('.domain-pill').forEach(pill => {
        if (pill.getAttribute('data-domain') === domain) {
            pill.classList.add('ring-2', 'ring-offset-2', 'ring-indigo-500');
        } else {
            pill.classList.remove('ring-2', 'ring-offset-2', 'ring-indigo-500');
        }
    });
    
    const searchQuery = document.getElementById('agent-search').value;
    renderAgentsByDomain(domain, searchQuery);
}

function showAgentDetail(agentName) {
    const agent = allAgents.find(a => a.name === agentName);
    if (!agent) return;
    
    const colors = DOMAIN_COLORS[agent.domain] || DOMAIN_COLORS.ops;
    const domain = allDomains.find(d => d.name === agent.domain);
    
    document.getElementById('modal-icon').textContent = agent.icon || domain?.icon || 'ü§ñ';
    document.getElementById('modal-title').textContent = agent.name;
    document.getElementById('modal-description').textContent = agent.description;
    document.getElementById('modal-module-path').textContent = agent.module_path;
    
    const badge = document.getElementById('modal-domain-badge');
    badge.className = `text-sm px-2 py-0.5 rounded-full ${colors.bg} ${colors.text}`;
    badge.textContent = domain?.label || agent.domain;
    
    const capabilitiesContainer = document.getElementById('modal-capabilities');
    capabilitiesContainer.innerHTML = agent.capabilities.map(cap => 
        `<span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">${cap}</span>`
    ).join('');
    
    document.getElementById('agent-modal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('agent-modal').classList.add('hidden');
}

function clearSearch() {
    document.getElementById('agent-search').value = '';
    renderAgentsByDomain(currentFilter, '');
}

// Search functionality with debounce
let searchTimeout;
document.getElementById('agent-search').addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        renderAgentsByDomain(currentFilter, e.target.value);
    }, 300);
});

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

// Close modal on backdrop click
document.getElementById('agent-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeModal();
});
</script>
{% endblock %}
