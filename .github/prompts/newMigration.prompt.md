---
name: newMigration
description: Create an Alembic database migration for CaseyOS
---
Create an Alembic migration for the following database change:

## Migration Details
- **Description**: ${1:What this migration does}
- **Table(s)**: ${2:Table names affected}

## Steps

### 1. Generate Migration File

```bash
# Generate empty migration
cd /workspaces/sales-agent
alembic -c infra/alembic.ini revision --autogenerate -m "${description}"
```

### 2. Edit Migration File

```python
"""${description}

Revision ID: <auto-generated>
Revises: <previous>
Create Date: <auto>
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = '<auto>'
down_revision = '<auto>'
branch_labels = None
depends_on = None


def upgrade() -> None:
    # Add column example
    op.add_column('table_name', sa.Column('new_column', sa.String(255), nullable=True))
    
    # Create table example
    op.create_table(
        'new_table',
        sa.Column('id', sa.String(36), primary_key=True),
        sa.Column('name', sa.String(255), nullable=False),
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
    )
    
    # Create index example
    op.create_index('ix_table_column', 'table_name', ['column_name'])


def downgrade() -> None:
    # Reverse the upgrade
    op.drop_index('ix_table_column')
    op.drop_table('new_table')
    op.drop_column('table_name', 'new_column')
```

### 3. Apply Migration

```bash
# Apply migration
python run_migrations.py

# Or directly with alembic
alembic -c infra/alembic.ini upgrade head
```

### 4. Verify

```bash
# Check current revision
alembic -c infra/alembic.ini current

# View migration history
alembic -c infra/alembic.ini history
```

## Rollback

```bash
# Rollback one migration
alembic -c infra/alembic.ini downgrade -1

# Rollback to specific revision
alembic -c infra/alembic.ini downgrade <revision_id>
```

## Common Patterns

### Add JSONB Column (PostgreSQL)
```python
op.add_column('table', sa.Column('metadata', postgresql.JSONB, nullable=True))
```

### Add Enum Column
```python
status_enum = postgresql.ENUM('pending', 'active', 'completed', name='status_type')
status_enum.create(op.get_bind())
op.add_column('table', sa.Column('status', status_enum, nullable=False, server_default='pending'))
```

### Add Foreign Key
```python
op.add_column('child_table', sa.Column('parent_id', sa.String(36), sa.ForeignKey('parent_table.id')))
```
